<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Birthday GPS for Krisztian</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body,#map {
  height:100%;
  margin:0;
  padding:0;
}
#controls{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1000;
  background:rgba(255,255,255,0.95);
  padding:10px 14px;
  border-radius:12px;
  font-family:sans-serif;
  width:90%;
  max-width:220px;
  text-align:center;
}
.btn{
  flex:1;
  padding:12px 0;
  border-radius:8px;
  border:1px solid #ccc;
  background:#f7f7f7;
  font-size:16px;
}

#giftIcon {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  font-size: 4rem;
  cursor: pointer;
  display: none;
  z-index: 3000;
  animation: bounce 1s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -60%) scale(1.2); }
}

#distanceBox {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(255,255,255,0.9);
  padding: 8px 14px;
  border-radius: 10px;
  font-family: sans-serif;
  font-size: 16px;
  z-index: 1500;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
</style>
</head>
<body>
<div id="map"></div>
<div id="distanceBox">Distance: -- m</div>
<div id="controls">
  <button id="startBtn" class="btn">Start</button>
</div>
<div id="giftIcon">üéÅ</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// --- Map Setup ---
const map = L.map('map',{zoomControl:false}).setView([47.5,19],14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// --- Car Marker ---
const carIcon = L.icon({
    iconUrl: 'https://Dorisz1.github.io/assets/car.png',
    iconSize: [64, 64],
    iconAnchor: [32, 32]
});
let carMarker = null;

// --- Destination ---
const destination = L.latLng(47.50106631785516, 19.032813874256586);

// --- Destination Marker ---
const destinationIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/11529/11529542.png',
    iconSize: [48,48],
    iconAnchor: [24,48],
    popupAnchor: [0,-48]
});
L.marker(destination, {icon: destinationIcon}).addTo(map).bindPopup("Destination");

// --- Audio ---
const audioStart = 'https://Dorisz1.github.io/assets/start.mp3';
const audioTurnLeft = 'https://Dorisz1.github.io/assets/turnleft.mp3';
const audioTurnRight = 'https://Dorisz1.github.io/assets/turnright.mp3';
const audioArrival = 'https://Dorisz1.github.io/assets/arrival.mp3';
const birthdaySong = 'https://Dorisz1.github.io/assets/birthdaysong.mp3';

function playAudio(url){
    const audio = new Audio(url);
    audio.play();
}

// --- Bearing & Turn Detection ---
let arrived = false;
let lastBearing = null;

function getBearing(lat1, lon1, lat2, lon2){
  const dLon = (lon2-lon1)*Math.PI/180;
  const y = Math.sin(dLon)*Math.cos(lat2*Math.PI/180);
  const x = Math.cos(lat1*Math.PI/180)*Math.sin(lat2*Math.PI/180) -
            Math.sin(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.cos(dLon);
  const brng = Math.atan2(y,x)*180/Math.PI;
  return (brng+360)%360;
}

// --- Update Car ---
function updateCar(latlng){
    if(!carMarker){
        carMarker = L.marker(latlng,{icon:carIcon}).addTo(map);
        map.setView(latlng,16);
    } else {
        carMarker.setLatLng(latlng);
    }

    map.setView(latlng,16);

    // Turn detection
    const bearing = getBearing(latlng.lat, latlng.lng, destination.lat, destination.lng);
    if(lastBearing!==null){
        let diff = bearing - lastBearing;
        if(diff>180) diff-=360;
        if(diff<-180) diff+=360;
        if(diff>30) playAudio(audioTurnRight);
        else if(diff<-30) playAudio(audioTurnLeft);
    }
    lastBearing = bearing;

    // Distance + Arrival logic
    const distance = latlng.distanceTo(destination);
    document.getElementById('distanceBox').innerText =
        "Distance: " + Math.round(distance) + " m";

    if(distance = 60){
        arrived = true;
        playAudio(audioArrival);
    }

    if(distance < 30){
        document.getElementById('giftIcon').style.display='block';
    }
}

// --- Start Button ---
document.getElementById('startBtn').onclick = function(){
    playAudio(audioStart);

    // Schedule timed audios
    setTimeout(()=> playAudio('https://dorisz1.github.io/assets/1.mp3'), 3*60*1000); // 5 min
    setTimeout(()=> playAudio('https://dorisz1.github.io/assets/2.mp3'), 5*60*1000); // 8 min total
    setTimeout(()=> playAudio('https://dorisz1.github.io/assets/3.mp3'), 7*60*1000); // 11 min total

    if(navigator.geolocation){
        navigator.geolocation.watchPosition(pos=>{
            const latlng = L.latLng(pos.coords.latitude,pos.coords.longitude);
            updateCar(latlng);
        }, err=>alert("GPS error: "+err.message), {enableHighAccuracy:true});
    } else alert("Geolocation not supported");
};

// --- Gift Icon Click ---
document.getElementById('giftIcon').onclick = function(){
    playAudio(birthdaySong);
};
</script>
</body>
</html>
