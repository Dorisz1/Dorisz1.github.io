<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Birthday GPS for Christian</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<style>
html,body,#map {height:100%;margin:0;padding:0;}
#controls{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);
z-index:1000;background:rgba(255,255,255,0.95);padding:10px 14px;
border-radius:12px;font-family:sans-serif;width:90%;max-width:220px;text-align:center;}
.btn{flex:1;padding:12px 0;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;font-size:16px;}
#giftIcon{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
font-size:4rem;cursor:pointer;display:none;z-index:3000;}
</style>
</head>
<body>
<div id="map"></div>
<div id="controls">
  <button id="startBtn" class="btn">Start</button>
</div>
<div id="giftIcon">üéÅ</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<script>
// --- Map Setup ---
const map = L.map('map',{zoomControl:false}).setView([47.5,19],14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

// --- Car Marker (bigger) ---
const carIcon = L.icon({
    iconUrl: 'https://Dorisz1.github.io/assets/car.png',
    iconSize: [64,64],     // bigger size
    iconAnchor: [32,32]    // center anchor
});
let carMarker = null;

// --- Destination ---
const destination = L.latLng(47.5007,19.0336);
const fallbackStart = L.latLng(47.498,19.04);

// --- Audio ---
const audioStart = 'https://Dorisz1.github.io/assets/start.mp3';
const audioTurnLeft = 'https://Dorisz1.github.io/assets/turnleft.mp3';
const audioTurnRight = 'https://Dorisz1.github.io/assets/turnright.mp3';
const audioArrival = 'https://Dorisz1.github.io/assets/arrival.mp3';
const birthdaySong = 'https://Dorisz1.github.io/assets/birthdaysong.mp3';
function playAudio(url){ new Audio(url).play(); }

// --- Routing Machine ---
let routingControl = L.Routing.control({
    waypoints:[fallbackStart, destination],
    router: L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1'}),
    lineOptions:{styles:[{color:'#FFA500',weight:5}]},
    addWaypoints:false,
    draggableWaypoints:false,
    fitSelectedRoutes:false,
    createMarker:()=>null
}).addTo(map);

// Store route steps for turn detection
let routeSteps = [];
routingControl.on('routesfound', function(e){
    const route = e.routes[0];
    routeSteps = [];
    route.instructions.forEach(inst=>{
        routeSteps.push({
            latlng: L.latLng(inst.lat, inst.lng),
            type: inst.type,
            done:false
        });
    });
});

// --- Update car position ---
let arrived = false;
function updateCar(latlng){
    if(!carMarker){
        carMarker = L.marker(latlng,{icon:carIcon}).addTo(map);
        map.setView(latlng,16);
    } else {
        carMarker.setLatLng(latlng);
    }

    // Update route
    routingControl.setWaypoints([latlng,destination]);
    map.setView(latlng,16);

    // Check for turns
    routeSteps.forEach(step=>{
        if(!step.done && latlng.distanceTo(step.latlng)<10){
            if(step.type==='turn-left') playAudio(audioTurnLeft);
            else if(step.type==='turn-right') playAudio(audioTurnRight);
            step.done = true;
        }
    });

    // Arrival
    if(!arrived && latlng.distanceTo(destination)<10){
        arrived = true;
        playAudio(audioArrival);
        document.getElementById('giftIcon').style.display='block';
    }
}

// --- Start Button ---
document.getElementById('startBtn').onclick = function(){
    playAudio(audioStart);
    if(navigator.geolocation){
        navigator.geolocation.watchPosition(pos=>{
            const latlng = L.latLng(pos.coords.latitude,pos.coords.longitude);
            updateCar(latlng);
        }, err=>alert("GPS error: "+err.message), {enableHighAccuracy:true});
    } else alert("Geolocation not supported");
};

// --- Gift Icon ---
document.getElementById('giftIcon').onclick = function(){
    playAudio(birthdaySong);
};
</script>
</body>
</html>
